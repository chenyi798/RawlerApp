name: Build Data Crawler App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        python-version: [3.11]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug - List files
      run: |
        echo "=== 当前目录文件列表 ==="
        if [ "$RUNNER_OS" == "Windows" ]; then
          dir
        else
          ls -la
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Application
      run: |
        # 清理旧的构建
        if [ "$RUNNER_OS" == "Windows" ]; then
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          
          pyinstaller --windowed --onefile --name "数据采集助手" `
            --add-data "eastmoney_crawler.py;." `
            --add-data "pbc_crawler.py;." `
            --hidden-import=curl_cffi `
            --collect-all curl_cffi `
            crawler_gui.py
        else
          rm -rf build dist
          
          pyinstaller --windowed --onefile --name "数据采集助手" \
            --add-data "eastmoney_crawler.py:." \
            --add-data "pbc_crawler.py:." \
            --hidden-import=curl_cffi \
            --collect-all curl_cffi \
            crawler_gui.py
        fi
    
    - name: Check build result
      run: |
        echo "=== 构建结果检查 ==="
        if [ "$RUNNER_OS" == "Windows" ]; then
          dir dist\
          if (Test-Path dist\数据采集助手.exe) {
            echo "✅ Windows 构建成功"
          } else {
            echo "❌ Windows 构建失败"
            exit 1
          }
        else
          ls -la dist/
          if [ -f "dist/数据采集助手" ]; then
            echo "✅ macOS 构建成功"
          else
            echo "❌ macOS 构建失败"
            exit 1
          fi
        fi
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 数据采集助手-${{ runner.os }}
        path: |
          dist/数据采集助手*
          dist/*.exe
        retention-days: 7
